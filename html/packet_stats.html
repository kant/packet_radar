<html>
<body>
    <style>
        body {
            font-size: 30px
        }

        div {
            padding: 20px;
        }
    </style>

    <script src="js/packet_server.js"></script>
    <script src="js/stats.js"></script>
    <script>
        var last = Date.now();

        var packet_count = new Counter();
        var byte_count = new Counter();
        var bytes_in = new Counter();
        var bytes_out = new Counter();

        var counter = new CountManager();
        counter.add('packet_count');
        counter.add('byte_count');
        counter.add('bytes_in', 'Data recv/sec');
        counter.add('bytes_out', 'Data sent/sec');

        var all_counter = new CountManager();
        all_counter.add('all_bytes_in', 'Data received');
        all_counter.add('all_bytes_out', 'Data sent');

        counter.forEach((counter, name) => createDiv(name));
        all_counter.forEach((counter, name) => createDiv(name));

        // TODO fix this
        var local_ip4 = '192.168.0.10';
        var local_ip6 = '2601:602:9100:2130:894f:d24f:d838:8851';
        // 2601:602:9100:2130:1c90:17fe:6881:7a7

        function createDiv(label) {
            var div = document.createElement('div');
            div.id = label + '_label';
            document.body.appendChild(div);
        }

        function formatBytes(number) {
            if (number < 1024) {
                return number.toFixed(3) + ' B';
            }

            number /= 1024;
            if (number < 1024) {
                return number.toFixed(3) + ' KB';
            }

            number /= 1024;
            if (number < 1024) {
                return number.toFixed(3) + ' MB';
            }

            number /= 1024;
            if (number < 1024) {
                return number.toFixed(3) + ' GB';
            }

            number /= 1024;
            return number.toFixed(3) + ' TB';
        }

        const INTERVAL = 3000;

        function updateStats() {
            var now = Date.now();
            var diff = now - last;
            last = now;
            var PER_SEC = 1000 / diff;
            // updates counter every 2 seconds
            packet_count_label.innerHTML = (packet_count.reset() * PER_SEC).toFixed(2) + ' packets / second';

            var bytes = byte_count.reset();
            var bps = (bytes * PER_SEC);
            byte_count_label.innerHTML = formatBytes(bps) + ' / second';

            bytes_in_label.innerHTML = formatBytes(bytes_in.reset() * PER_SEC) + ' in / second';
            bytes_out_label.innerHTML = formatBytes(bytes_out.reset() * PER_SEC) + ' out / second';

            all_counter.forEach((counter, name) => {
                window[`${name}_label`].innerHTML = `${counter.label}: ${formatBytes(counter.val() * PER_SEC)}`
            })

            setTimeout(updateStats, INTERVAL);
        }

        updateStats();

        connect_packet_server(data => {
            // console.log(data);
            var len = data.len;
            var src = data.src;

            packet_count.inc();
            byte_count.inc(len);

            if (src === local_ip4 || src  === local_ip6) {
                bytes_out.inc(len);
                all_counter.inc('all_bytes_out', len);
            } else {
                bytes_in.inc(len);
                all_counter.inc('all_bytes_in', len);
            }
        });

        // IDEAS
        // use different internval (1s, 3s, 10s) or use exponential decaying/moving average
        // average, 50, 95, 98 packet size?
        // line graph
        // filter or breakdown
        // make dashboard configurable + bindings to counters
    </script>
</body>
</html>